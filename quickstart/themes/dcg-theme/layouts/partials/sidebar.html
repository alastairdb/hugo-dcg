<aside class="w-100 w-30-l pa3 pa4-l">
  <!-- Search Section -->
  <div class="bg-white pa3 mb4 ba b--light-gray">
    <h3 class="f4 fw6 mb3 mid-gray">{{ i18n "search" | default "Suche" }}</h3>
    <div class="relative">
      <input type="text" id="search-input" placeholder="{{ i18n `search_placeholder` | default `Inhalte durchsuchen...` }}" 
             class="w-100 pa2 ba b--light-gray br2 f6">
      <div id="search-results" class="absolute w-100 bg-white ba b--light-gray br2 mt1 dn z-1 shadow-2">
        <div id="search-results-content" class="pa2 f6"></div>
      </div>
    </div>
  </div>

  <!-- Recent Posts Section -->
  <div class="bg-white pa3 mb4 ba b--light-gray">
    <h3 class="f4 fw6 mb3 mid-gray">{{ i18n "recent_posts" | default "Neueste Beiträge" }}</h3>
    {{ $recent := where .Site.RegularPages "Type" "in" (slice "post" "posts") | first 5 }}
    {{ if $recent }}
      <ul class="list pl0">
        {{ range $recent }}
          <li class="mb2">
            <a href="{{ .RelPermalink }}" class="link dark-gray hover-blue no-underline">
              {{ .Title }}
            </a>
            <div class="f6 gray">{{ .Date.Format "02.01.2006" }}</div>
          </li>
        {{ end }}
      </ul>
    {{ else }}
      <p class="f6 gray">{{ i18n "no_posts" | default "Keine Beiträge vorhanden" }}</p>
    {{ end }}
  </div>

  <!-- Archives Section -->
  <div class="bg-white pa3 mb4 ba b--light-gray">
    <h3 class="f4 fw6 mb3 mid-gray">{{ i18n "archives" | default "Archive" }}</h3>
    
    <!-- Month-based archive dropdown -->
    <select class="w-100 pa2 ba b--light-gray mb3" onchange="if(this.value) window.location.href=this.value">
      <option value="">{{ i18n "select_month" | default "Monat auswählen" }}</option>
      {{ $posts := where .Site.RegularPages "Type" "in" (slice "post" "posts") }}
      {{ $validPosts := slice }}
      {{ range $posts }}
        {{ if and .Date (not .Date.IsZero) (gt .Date.Year 1900) }}
          {{ $validPosts = $validPosts | append . }}
        {{ end }}
      {{ end }}
      {{ range ($validPosts.GroupByDate "2006-01") }}
        {{ $month := .Key }}
        {{ $url := printf "/%s/posts/" $.Site.Language.Lang }}
        <option value="{{ $url }}?month={{ $month }}">{{ .Key }} ({{ len .Pages }})</option>
      {{ end }}
    </select>
    
    <!-- Year-based archive links -->
    <div class="mt3">
      <h4 class="f5 fw6 mb2 mid-gray">{{ i18n "by_year" | default "Nach Jahr" }}</h4>
      <ul class="list pl0">
        {{ $posts := where .Site.RegularPages "Type" "in" (slice "post" "posts") }}
        {{ $validPosts := slice }}
        {{ range $posts }}
          {{ if and .Date (not .Date.IsZero) (gt .Date.Year 1900) }}
            {{ $validPosts = $validPosts | append . }}
          {{ end }}
        {{ end }}
        {{ range ($validPosts.GroupByDate "2006") }}
          <li class="mb1">
            {{ $url := printf "/%s/posts/" $.Site.Language.Lang }}
            <a href="{{ $url }}?year={{ .Key }}" class="link dark-gray hover-blue no-underline">
              {{ .Key }}
            </a>
            <span class="f6 gray">({{ len .Pages }})</span>
          </li>
        {{ end }}
      </ul>
    </div>
  </div>

  <!-- Categories Section -->
  <div class="bg-white pa3 mb4 ba b--light-gray">
    <h3 class="f4 fw6 mb3 mid-gray">{{ i18n "categories" | default "Kategorien" }}</h3>
    {{ $categories := .Site.Taxonomies.categories }}
    {{ if $categories }}
      <ul class="list pl0">
        {{ range $name, $taxonomy := $categories }}
          <li class="mb1">
            <a href="/categories/{{ $name | urlize }}/" class="link dark-gray hover-blue no-underline">
              {{ $name | title }}
            </a>
            <span class="f6 gray">({{ len $taxonomy }})</span>
          </li>
        {{ end }}
      </ul>
    {{ else }}
      <p class="f6 gray">{{ i18n "no_categories" | default "Keine Kategorien vorhanden" }}</p>
    {{ end }}
  </div>
</aside>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');
  const searchResultsContent = document.getElementById('search-results-content');
  
  // Build search index from all content
  const searchIndex = [
    {{ range .Site.RegularPages }}
    {
      title: {{ .Title | jsonify }},
      summary: {{ .Summary | jsonify }},
      content: {{ .Plain | jsonify }},
      url: {{ .RelPermalink | jsonify }},
      type: {{ .Type | jsonify }},
      date: {{ .Date.Format "2006-01-02" | jsonify }}
    },
    {{ end }}
  ];
  
  let searchTimeout;
  
  searchInput.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim().toLowerCase();
    
    if (query.length < 2) {
      searchResults.classList.add('dn');
      return;
    }
    
    searchTimeout = setTimeout(() => {
      const results = searchIndex.filter(item => {
        return item.title.toLowerCase().includes(query) ||
               item.summary.toLowerCase().includes(query) ||
               item.content.toLowerCase().includes(query);
      }).slice(0, 8); // Limit to 8 results
      
      if (results.length > 0) {
        searchResultsContent.innerHTML = results.map(result => {
          const title = result.title.replace(/"/g, '&quot;');
          const summary = result.summary ? result.summary.substring(0, 100).replace(/"/g, '&quot;') + '...' : '';
          const url = result.url.replace(/"/g, '');
          return `
            <div class="bb b--light-gray pb2 mb2 last-child-no-border">
              <a href="${url}" class="link dark-gray hover-blue no-underline db">
                <div class="fw6 f6">${title}</div>
                <div class="f7 gray mt1">${result.type} • ${result.date}</div>
                ${summary ? `<div class="f7 gray mt1">${summary}</div>` : ''}
              </a>
            </div>
          `;
        }).join('');
        searchResults.classList.remove('dn');
      } else {
        searchResultsContent.innerHTML = '<div class="f6 gray tc pa2">{{ i18n "no_search_results" | default "Keine Ergebnisse gefunden" }}</div>';
        searchResults.classList.remove('dn');
      }
    }, 300);
  });
  
  // Hide search results when clicking outside
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !searchResults.contains(e.target)) {
      searchResults.classList.add('dn');
    }
  });
  
  // Show results again when focusing on search input
  searchInput.addEventListener('focus', function() {
    if (this.value.trim().length >= 2) {
      searchResults.classList.remove('dn');
    }
  });
});
</script>
